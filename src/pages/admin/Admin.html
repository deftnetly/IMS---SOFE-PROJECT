<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS – Admin Panel</title>

    <link rel="stylesheet" href="../../styles/sidebar.css">
    <link rel="stylesheet" href="../../styles/content.css">
    <link rel="stylesheet" href="../../styles/logout-popup.css">
    <link rel="icon" type="image/png" href="../../assets/SIMS.png">

    <style>
        #main-content {
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        #main-content.visible {
            opacity: 1;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar-toggle" id="sidebarToggle">&#9776;</div>

    <div class="sidebar">
        <a href="#" onclick="openPage('dashboard','1_dashboard')">
            <img src="../../assets/dashboard.white.png"><span>Dashboard</span>
        </a>
        <a href="#" onclick="openPage('categories','2_categories')">
            <img src="../../assets/categories.white.png"><span>Categories</span>
        </a>
        <a href="#" onclick="openPage('products','3_products')">
            <img src="../../assets/white.png"><span>Products</span>
        </a>
        <a href="#" onclick="openPage('employees','4_employees')">
            <img src="../../assets/employee.white.png"><span>Employees</span>
        </a>
        <a href="#" onclick="openPage('transactions','5_transactions')">
            <img src="../../assets/transaction.white.png"><span>Transactions</span>
        </a>
        <a href="#" onclick="openPage('reports','6_reports')">
            <img src="../../assets/report.white.png"><span>Reports</span>
        </a>
        <a href="#" onclick="openPage('settings','7_settings')">
            <img src="../../assets/setting.white.png"><span>Settings</span>
        </a>
        <a href="#" class="logout" onclick="showLogoutPopup()">
            <img src="../../assets/exit.white.png"><span>Logout</span>
        </a>
    </div>

    <!-- Main Content -->
    <div class="content" id="main-content"></div>

    <!-- Logout Popup -->
    <div class="logout-popup" id="logoutPopup">
        <div class="logout-box">
            <h3>Are you sure you want to log out?</h3>
            <div class="logout-buttons">
                <button class="yes" onclick="confirmLogout()">Yes</button>
                <button class="no" onclick="closeLogoutPopup()">No</button>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT LOADER -->
    <script>

    // Save last page visited
    function saveLastPage(section, folder) {
        localStorage.setItem("lastSection", section);
        localStorage.setItem("lastFolder", folder);
    }

    // Called when clicking sidebar links
    function openPage(section, folder) {
        saveLastPage(section, folder);
        loadContent(section, folder);
    }

    async function loadContent(section, folder) {
    const container = document.getElementById("main-content");
    container.classList.remove("visible");
    container.innerHTML = `<div class="content-section"><h2>Loading ${section}...</h2></div>`;

    try {
        // 1. REMOVE ALL previous section scripts BEFORE loading the new one
        document.querySelectorAll("script[data-section]").forEach(s => s.remove());

        // 2. Load HTML
        const res = await fetch(`${folder}/${section}.html`);
        if (!res.ok) throw new Error(`Failed to load ${section}.html`);
        container.innerHTML = await res.text();

        // 3. Load script for this section
        const js = document.createElement("script");
        js.src = `${folder}/${section}.js`;
        js.setAttribute("data-section", section);

        js.onload = () => {
            console.log(section + " JS Loaded ✔");

            // WAIT FOR SCRIPT TO FINISH EXECUTING
            requestAnimationFrame(() => {
                document.dispatchEvent(
                    new CustomEvent("sectionLoaded", { detail: { section } })
                );

                if (section === "dashboard") {
                    document.dispatchEvent(new Event("dashboardLoaded"));
                }

                // Fade in after JS
                setTimeout(() => container.classList.add("visible"), 10);
            });
        };

        document.body.appendChild(js);

    } catch (err) {
        container.innerHTML = `<p>Error loading section: ${err.message}</p>`;
    }
}


    // On page refresh, load last opened section
    document.addEventListener("DOMContentLoaded", () => {
        const lastSection = localStorage.getItem("lastSection");
        const lastFolder = localStorage.getItem("lastFolder");

        if (lastSection && lastFolder) {
            loadContent(lastSection, lastFolder);
        } else {
            loadContent("dashboard", "1_dashboard");
        }
    });

    // Logout popup
    function showLogoutPopup() {
        document.getElementById("logoutPopup").classList.add("active");
    }
    function closeLogoutPopup() {
        document.getElementById("logoutPopup").classList.remove("active");
    }
    function confirmLogout() {
        document.body.style.opacity = 0;
        setTimeout(() => {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "../../login/Login.html";
        }, 500);
    }
    </script>

    <!-- Sidebar script -->
    <script src="../../scripts/sidebar.js"></script>

</body>
</html>
